<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="style.css">
    
    </head>
    <body>
            <div id="local"></div>
            
            
        <div id="app" ></div>
        
    
<!-- モーダルウィンドウを開くボタン -->
<div><a href="#modal01" class="modalOpen"></a></div>

<!-- モーダルウィンドウ -->
<div class="modal" id="modal01">

    <!-- モーダルウィンドウが開いている時のオーバーレイ -->
    <div class="overLay modalClose"></div>

    <!-- モーダルウィンドウの中身 -->
    <div class="inner">
    user login
        <form>
            <input type="text" id="player" value="">
            <input type="button" id="save" value=" login ">
        </form>
    </div>

</div>


<style>




</style>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>









let player = localStorage.player;  
if(player){
}
else{
    let href = $('.modalOpen').attr("href");
    $(href).fadeIn();
    }
    $("#local").html("<p>Player1:"+player+"</p>");

$("#save").click(function(){
    let str= $("#player").val();
    if( str==''){
        alert('user名を入力してください');
      
    }else{
  $(this).parents(".modal").fadeOut(); 
  localStorage.setItem( "player" , str ); 
  $("#local").html("<p>Player1:"+str+"</p>");
    }
    });  
   

    

let imgArr=[];
    for(i=0; i>=-420; i+=-30){
        imgArr.push("<img style='object-fit: cover; object-position: "+i+"px' src='/img/img.png'>")
    }
console.log(imgArr);



const render = (board2) => {
  // DOMを破棄して再構築


$("#app").empty();

let html = '';

    board2.forEach((row) =>{
    html += '<div class="row">';
        row.forEach((block) => {
            const openedClass = block.opened ? "block opened" : "block close";
            const userName = block.user || '';
            const numberImg = imgArr[block.number-1];
            const bomImg = block.exploded ?  imgArr[10] :'';
            const flagImg = block.safeflag ?  imgArr[9] :'';

            html +=`<div class="${openedClass}">${numberImg || bomImg || flagImg }</div>`;
           
        });

        html+= '</div>';
    });

    $("#app").html(html);



$('.block').mousedown(function(event) {
    switch (event.which ) {
        case 3:
         if($(this).hasClass("close")){
            let index = $('.block').index(this);

if (index <= 9) {
  index ='0'+ index
} 
let num = index.toString();
let y= num.substring(0,1)
let x= num.substring(1)
const user =localStorage.player;
const safeflag =true

$.getJSON('/board', {
  x,
  y,
  user,
  safeflag,
  
}, render);
         }
            break;
        case 1:
        let index = $('.block').index(this);

if (index <= 9) {
  index ='0'+ index
} 
let num = index.toString();
let y= num.substring(0,1)
let x= num.substring(1)
//   console.log(x,y,this);
const user =localStorage.player;


$.getJSON('/board', {
  // x: x,
  // y: y,
  // user: user,下と同じ書き方
  x,
  y,
  user, 
}, render);


        
            break;
    }
});

// $('.block').bind('contextmenu',function(){
// if ($(this).hasClass("close")) {
//     let index = $('.block').index(this);

//   if (index <= 9) {
//     index ='0'+ index
//   } 
//  let num = index.toString();
//  let y= num.substring(0,1)
//  let x= num.substring(1)
//  const user =localStorage.player;
//  const safeflag =true

//   $.getJSON('/board', {
//     x,
//     y,
//     user,
//     safeflag,
    
//   }, render);
//   }
//   return false 
// });    



// $('.block').click(function() {

// let index = $('.block').index(this);

//   if (index <= 9) {
//     index ='0'+ index
//   } 
//  let num = index.toString();
//  let y= num.substring(0,1)
//  let x= num.substring(1)
// //   console.log(x,y,this);
//  const user =localStorage.player;


//   $.getJSON('/board', {
//     // x: x,
//     // y: y,
//     // user: user,下と同じ書き方
//     x,
//     y,
//     user, 
//   }, render);
// });

// }

}

setInterval(() => {
  // 0.5秒ごとにサーバーにポーリング
  $.getJSON('/board', render);
}, 500);




        </script>
    </body>
</html>